## PACKAGES ##
library(shiny)
library(shinydashboard)
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(janitor)
library(tidyverse)
library(lubridate)
library(scales)
#library(khroma)
library(patchwork)
library(tools)
library(ggtext)
library(png)
library(ggpubr)
library(leaflet)

# SET TO TRUE AT THE END TO GET RID OF ALL POSSIBLE ERRORS
#options(shiny.sanitize.errors = FALSE)

## UI ##
ui <- dashboardPage(
  skin = "black",
  dashboardHeader(
    title = tags$a(href='https://mralph15.shinyapps.io/dashboard/',
                   tags$img(src = 'food_point_logo.png', height='40', width='180'))
  ),
  dashboardSidebar(
    sidebarMenu(
      menuItem(
        "Overview",
        tabName = "overview", icon = icon("dashboard")
      ),
      menuItem(
        "Upload Instructions",
        tabName = "upload", icon = icon("copy")
      ),
      menuItem(
        "Spending Over Time",
        tabName = "future", icon = icon("chart-line")
      ),
      menuItem(
        "Dining Locations",
        tabName = "locations", icon = icon("map-marked")
      ),
      menuItem(
        "Top 5 Restaurants",
        tabName = "restaurants", icon = icon("utensils")
      ),
      menuItem(
        "Food Point Tips",
        tabName = "spendingtips", icon = icon("money-check-alt")
      ),
      menuItem(
        "Write Up",
        tabName = "writeup", icon = icon("pencil-alt")
      )
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "upload",
        h2("How to Access and Upload Your Food Points:"),
        fluidRow(
          img(
            src = "food-points-instructions.png", height = 800, width = 700,
            style = "display: block; margin-left: auto; margin-right: auto;"
          ),
        )
      ),
      tabItem(
        tabName = "overview",
        h2("Food Points Overview"),
        fluidRow(
          box(downloadButton("food_template", "Download Food Point Template"),
              h4(""),
              fileInput("student_data", "Upload Your Food Point Usage\n(see upload instructions tab)"),
              height = 200,
              accept = ".csv"
          ),
          box(
            align = "center",
            infoBoxOutput(width = 12, "plan_detected"),
            tableOutput("summary_table"), height = 200
          )
        ),
        fluidRow(
          column(12,
                 align = "center", offset = 2,
                 box(
                   align = "center", width = 8,
                   DT::dataTableOutput("user_points_table")
                 )
          )
        ),
      ),
      tabItem(
        tabName = "future",
        h2("Spending Over Time"),
        fluidRow(
          box(
            selectInput("select_sem", "Select Semester:",
                        choices = c("Fall", "Spring")
            ),
            selectInput("select_plan", "Select a Food Plan:",
                        choices = c(
                          "Plan A", "Plan B", "Plan C", "Plan D",
                          "Plan F", "Plan I", "Plan J"
                        )
            ),
            checkboxInput(
              "negative_values",
              "Allow progression to display negative food points remaining?",
              value = FALSE
            ),
            height = 220, width = 4
          ),
          box(align = "center", h4("Selected Plan Characteristics\n \n "),
              tableOutput("plan_select_table"),
              height = 220, width = 4
          ),
          box(
            plotOutput("overtime_key"),
            height = 220, width = 4
          )
        ),
        fluidRow(
          box(
            plotOutput("overtime2")
          ),
          box(
            plotOutput("overtime1")
          )
        ),
      ),
      tabItem(
        tabName = "locations",
        h2("Where Food Points Are Spent"),
        fluidRow(
          column(12,
                 align = "center", offset = 3,
                 box(
                   align = "center", width = 6,
                   uiOutput("location_date_range")
                 )
          )
        ),
        fluidRow(
          column(12,
                 align = "center", offset = 1,
                 box(
                   align = "center", width = 10, height = 500,
                   plotOutput("top_5_locations",
                              dblclick = "map_dblclick",
                              brush = brushOpts(id = "map_brush",
                                                resetOnNew = TRUE))
                 )
          )
        )
      ),
      tabItem(
        tabName = "writeup",
        h2("Project Write Up:")
      ),
      tabItem(
        tabName = "spendingtips",
        h2("Food Point Spending Tips"),
        fluidRow(
          # Sidebar with a slider input for the number of bins
          column(12,
                 h3("If you are running low on food points:"),
                 p("- Look at the Top 5 Restaurant bar plots and consider frequenting
          your top average spending locations less often. If you really enjoy
          these restaurants, consider ordering their $5 Daily Devil Deals,
          instead. If these top locations have a food in common, such as
            coffee, consider getting the monthly Panera coffee card"),
                 p("- View the data table on the Top 5 tab and frequent the location
            with the smallest average spending more often."),
                 p("- View the spending per week visualization and consider how your
            spending each week compares to your plan’s weekly average. Were
            there particular weeks where your spending was notably above the
            average amount? Consider what was going on during these weeks, and
            how you can use knowledge of this in the future."),
                 p("- Look at how your plan progression compares to your own spending.
            Would a different plan be more suitable for you in future
            semesters?"))),
        fluidRow(
          column(12,
                 h3("If you have too many food points remaining:"),
                 p("- Look at the Top 5 Restaurant bar plots and consider frequenting
            your top average spending locations more often."),
                 p("- View the spending per week visualization and consider how your
          spending each week compares to your plan’s weekly average. Were there
          particular weeks where your spending was notably below the average
          amount? Consider what was going on during these weeks, and how you can
          use knowledge of this in the future."),
                 p("- Look at how your plan progression compares to your own spending.
          Would a different plan be more suitable for you in future semesters?"),
                 p("- Consider going to The Lobby Shop more to stock up on snacks, or
          getting Merchants on Points."))
        )),
      tabItem(
        tabName = "restaurants",
        h2("Your Top 5 Restaurants"),
        fluidRow(
          column(12,
                 align = "center",
                 uiOutput("daterange2"),
          )
        ),
        fluidRow(
          column(12,
                 align = "center", offset = 1,
                 box(
                   align = "center", width = 10,
                   selectInput(
                     "top_5_input",
                     "Which Measure(s) Would You Like Visualized?",
                     c(
                       "All Three: Total Swipes, Total Spent, & Avg. Spent",
                       "Total Number of Swipes per Restaurant",
                       "Total Food Points Spent per Restaurant",
                       "Average Food Points Spent per Restaurant"
                     )
                   )
                 )
          )
        ),
        fluidRow(
          column(12,
                 align = "center",
                 wellPanel(plotOutput("plot_top_5")))

        ),
        fluidRow(
          column(12,
                 align = "center", offset = 2,
                 box(
                   align = "center", width = 8,
                   DT::dataTableOutput("food_points_all_info_table")
                 )
          )

        )
      )
    )
  )
)